#!/usr/bin/env python3
import subprocess
from time import sleep

import pychromecast
from py_irsend import irsend

CHROMECAST_NAME = 'Bedroom TV'
TV = 'Sanyo_TV'
STATUS_PIN = 18

pychromecast.IGNORE_CEC.append('*')
CHROMECAST = None


def toggle_power():
    # Not entirely sure, but need to hold the power button for a bit
    for i in range(4):
        irsend.send_once(TV, ['KEY_POWER'])
    print('Toggled Power')


def configure_status():
    subprocess.run(f'gpio -g mode {STATUS_PIN} up'.split())


def is_on():
    status = subprocess.run(f'gpio -g read {STATUS_PIN}'.split(),
                            capture_output=True)
    txt = status.stdout.decode().strip()
    return not int(txt)


def is_correct_state():
    return is_on() != CHROMECAST.is_idle


if __name__ == '__main__':
    CHROMECAST = next((cc
        for cc in pychromecast.get_chromecasts()
        if cc.device.friendly_name == CHROMECAST_NAME), None)
    CHROMECAST.wait()
    last_state = CHROMECAST.is_idle
    states = [True] * 10

    configure_status()

    print('Polling Idle State')
    i = 0
    while True:
        i = (i + 1) % 10
        states[i] = is_correct_state()
        if True not in states:
            print('Correcting State')
            toggle_power()
            states = [True] * 10
            continue

        state = CHROMECAST.is_idle
        if state != last_state:
            last_state = state
            toggle_power()
        sleep(1)
